# 代码质量工具

---

## 集成`eidtorconfig`配置

`editorconfig`有助于为不同`IDE`编辑器上处理同一项目的多个开发人员维护一致的编码风格

例如Windows的Tab和Mac的`Tab`、`Enter`编码可能不同，`Tab`缩进空格数可能不同

- `.editorconfig`

```yaml
# http://editorconfig.org

root = true

[*]  # 表示所有文件适用
charset = utf-8  # 设置文字字符集为utf8
indent_style = space  # 缩进风格（space | tab）
indent_size = 2  # 缩进大小
end_of_line = lf  # 控制换行类型（lf | cr | crlf）
trim_trailing_whitespace = true  # 去除行首的任意空白字符
insert_final_newline = true  # 始终在文件末尾添加新行

[*.md]  # 表示仅对 .md 结尾的文件使用
max_line_length = off
trim_trailing_whitespace = false
```

当你打开一个文档即将coding的时候，`EditorConfig插件`就查找当前被编辑文件所在的目录有么有一个名为 `.editorconfig `的文件，
如果没有，则开始依次逐级向上查找当前目录的父目录，直到到达工程根目录，或者找到配置了`root=true`的配置文件。

如果一个工程中出现多个配置文件，EditorConfig配置文件的读取层级是自上而下的（类似于css规则），最深层的配置文件，最后读取。配置规则也是 按照读取的顺序来生效，所以路径上离代码最近的配置规则，优先级最高。

| 通配符     | 作用                                         |
| :----------: | :--------------------------------------------: |
| *          | 匹配任意数量string类型的字符，**' / '** 除外 |
| **         | 匹配任意数量string类型的字符                 |
| ？         | 匹配任意单个字符                             |
| [a-z]      | 匹配方括号规定范围内的任意单个字符           |
| [!a-z]     | 匹配不在方括号规定范围内的任意单个字符       |
| {s1,s2,s3} | 匹配任意一个大括号内部美剧的字符(','分隔)    |

VS Code中需要安装`EditorConfig for VS Code`插件来读取`.editorconfig`中的配置来进行格式化

## `prettier`

`yarn add -D prettier`

### 代码格式化

`yarn add -D eslint-plugin-prettier eslint-config-prettier`

- `.prettierrc.js`
- https://prettier.io/playground 可在该网址下自行配置

```javascript
module.exports = {
  printWidth: 100,
  // tabWidth: 2,
  // useTabs: false,
  semi: false, // 使用分号, default:  true
  singleQuote: true, // 单引号 default: false
  // quoteProps: 'as-needed',
  // jsxSingleQuote: false,
  trailingComma: 'none', // 未尾逗号 default: es5    all | none | es5
  // bracketSpacing: true,
  // bracketSameLine: false,
  // jsxBracketSameLine: false,
  // arrowParens: 'always',
  // insertPragma: false,
  // requirePragma: false,
  proseWrap: 'never',
  // htmlWhitespaceSensitivity: 'css',
  // vueIndentScriptAndStyle: false,  // .vue 缩进
  // endOfLine: 'lf'
}
```

之后在 package.json -> scripts 中添加格式化脚本

```json
"prettify": "prettier --ignore-path .gitignore --write \"**/*.+(js|ts|json)\""
```


VS Code中安装`Prettier - Code formatter`插件自动格式化

### scss 格式化

`yarn add -D stylelint stylelint-config-sass-guidelines stylelint-config-prettier stylelint-prettier`

- `.stylelintrc.json`

```json
{
  "plugins": ["stylelint-prettier"],
  "extends": [
    "stylelint-config-sass-guidelines",
    "stylelint-config-prettier",
    "stylelint-prettier/recommended"
  ]
}
```

之后在 package.json -> scripts 中添加格式化脚本

```js
"lint:scss": "stylelint './**/*.scss' --fix"
```

## 代码规范检查`eslint`

`eslint` 解决的问题是代码格式化校验，而代码格式化交给 `prettier`

### 初始化 `eslint`

1. 通过官方脚手架初始化 `npx eslint --init`，最后会自动安装 `eslint@latest`

2. ![image-20220109160749012](https://gitee.com/RealBBboy/mark-down-images-repo/raw/master/NoteImg/image-20220109160749012.png)

3. ![image-20220109161050186](https://gitee.com/RealBBboy/mark-down-images-repo/raw/master/NoteImg/image-20220109161050186.png)

4. ![image-20220109161109884](https://gitee.com/RealBBboy/mark-down-images-repo/raw/master/NoteImg/image-20220109161109884.png)

   > 选择 Vue 的话会自动安装 `eslint-plugin-vue@latest`

5. ![image-20220109161305468](https://gitee.com/RealBBboy/mark-down-images-repo/raw/master/NoteImg/image-20220109161305468.png)

   > 如果选择使用 typescript 则会安装 `@typescript-eslint/eslint-plugin@latest` 以及 `@typescript-eslint/parser@latest`
   >
   > 如果项目中没有安装 typescript 你还需要 `yarn add -D typescript`

完成安装后的 package.json 文件：

```json
 "devDependencies": {
    "@typescript-eslint/eslint-plugin": "^5.7.0",
    "@typescript-eslint/parser": "^5.7.0",
    "eslint": "^8.5.0",
    "eslint-plugin-vue": "^8.2.0"
  }
```

.eslintrc.js 文件：

```js
module.exports = {
    "env": {
        "browser": true,
        "es2021": true,
    },
    "extends": [  // 预设的校验规则
        "eslint:recommended",
        "plugin:vue/essential",
        "plugin:@typescript-eslint/recommended"
    ],
    "parserOptions": {
        "ecmaVersion": 13,  // 13 指的是es的版本 为了更通俗些可以改成2021
        "parser": "@typescript-eslint/parser",
        "sourceType": "module"
    },
    "plugins": ["vue", "@typescript-eslint"],
    "rules": {}
};
```

之后再在 package.json -> scripts 中添加校验脚本

```json
"lint:code": "eslint --ignore-path .gitignore . --ext .ts,.vue --fix"
```

> eslint 默认只检测.js的文件， 所以需要 **--ext** 来指定文件类型

### 根据当前项目环境做相应修改

.eslintrc.js -> extends -> `"plugin:vue/essential"` 是 Vue2 的配置，使用 Vue3 时，需要将其改成 `"plugin:vue/vue3-essential"`

```js
"extends": [
    "eslint:recommended",
    // "plugin:vue/essential",
    "plugin:vue/vue3-essential",
    "plugin:@typescript-eslint/recommended"
],
```

去掉 .eslintrc.js -> plugins 中的 `"vue"`

### 添加 prettier 的配置

> prettier 有两种方案
>
> - prettier 和 eslint-config-prettier 配置的化直接`.eslintrc.js` extends里加上'prettier'
> - 再安装eslint-plugin-prettier(推荐使用) 配置 extends: ['plugin:prettier/recommended']

```js
{
  "extends": [ // extends 指定扩展的配置, 支持规则的覆盖和聚合
    ...
    "plugin:prettier/recommended", // 如果同时使用了eslint和prettier发生冲突了，会关闭掉与prettier有冲突的规则，也就是使用prettier认为对的规则
  ],
  "plugins": [ // plugins 配置那些我们想要Linting规则的插件。
    ...
    "prettier", // eslint 会使用pretter的规则对代码格式化
  ],
  "rules": {
    "prettier/prettier": 2, // 这项配置 对于不符合prettier规范的写法，eslint会提示报错
  }  
}
```

## `lint-staged` 校验 git 暂存区

### 前置：

1. 配置了 `eslint  [ prettire ]`
2. 当前项目被 git 管理（`git init`）

`lint-staged` 只会对 git 提交到暂存区的代码进行 lint 操作

### 方案一：脚本自动化 `npx mrm@2 lint-staged`

完成后会自动安装 `lint-staged` 与 `husky`，并创建 husky 的配置文件，并在 package.json 中添加`"lint-staged": {"*.js": "eslint --cache --fix"}`

![自动生成husky的配置](https://gitee.com/RealBBboy/mark-down-images-repo/raw/master/NoteImg/image-20220109182014647.png)

> 编辑其中的`pre-commit`来设置 git 钩子命令，默认会添加 lint-staged

它将根据 package.json 依赖项中的代码质量工具来安装和配置husky和`lint-staged`，因此请确保在此之前安装（`yarn`）并配置所有代码质量工具，如 Prettier 和 ESlint

在 package.json 中修改 `lint-staged` 配置

```json
"lint-staged": {
    "*.{ts,vue}": [
      "prettier --write",
      "yarn lint:code"
	]
 }
```

> 该配置将`your-cmd`使用作为参数传递的当前暂存文件的列表执行。
>
> 因此，考虑到您做了`git add file1.ext file2.ext`，`lint-staged`将运行以下命令：
>
> ```bash
> your-cmd file1.ext file2.ext
> ```

### 方案二：手动配置

- 优势：不用创建 `.husky` 文件夹

`yarn add -D husky lint-staged`

在 package.json 中添加配置

```json
"husky": {
    "pre-commit": "lint-staged"
},
"lint-staged": {
    "*.scss": "yarn lint:scss"
}
```



## git代码提交信息

### 风格规范`commitizen`

`commitizen`是一个帮助我们规范`commit message`的工具

`yarn add -D commitizen`

使用 Angular 提交信息规范适配器 `npx commitizen init cz-conventional-changelog --yarn --dev --exact`

这个命令会安装 `cz-conventional-changelog` 并在 package.json 中添加配置：

```json
"config": {
    "commitizen": {
        "path": "./node_modules/cz-conventional-changelog"  // 告诉 commitizen 当提交信息的时候要使用的适配器
    }
}
```

此时提交代码则可以在 package.json -> scripts 中添加 `"cm": "cz"`，之后使用 `yarn commit` 提交代码即可

然后就可以在 README.md 中添加 Commitizen-friendly 徽章 `[![Commitizen friendly](https://img.shields.io/badge/commitizen-friendly-brightgreen.svg)](http://commitizen.github.io/cz-cli/)`

- 选择本次更新的类型

| Type     | 作用                                                         |
| -------- | ------------------------------------------------------------ |
| feat     | 新增特性(feature)                                            |
| fix      | 修复 Bug(bug fix)                                            |
| docs     | 修改文档(documention)                                        |
| style    | 代码格式修改(white-space, formatting, missing semi colons, etc) |
| refactor | 代码重构(refactor)                                           |
| pref     | 改善性能(A code change that imporves performance)            |
| test     | 测试(when add missing tests)                                 |
| build    | 变更项目构建或外部依赖                                       |
| ci       | 更改持续集成软件的配置文件和 package 中的 scripts 命令       |
| chore    | 变更构建流程或辅助工具(例如更改测试环境)                     |
| revert   | 代码回退                                                     |

- 选择本次修改的范围

- 选择提交的信息

### 提交限制`commitlint`

对提交的信息进行风格验证

有了提交风格规范后但是不能阻止用户继续使用`git add . && git commit -m '.'`提交信息，因此有了`commitlint`

`yarn add -D @commitlint/config-conventional @commitlint/cli`

在项目根目录下创建`commitlint.config.js`

```js
module.exports = {
    extends: ['@commitlint/config-conventional']
}
```

在Husky中添加git钩子验证提交的信息

`npx husky add .husky/commit-msg "npx --no-install commitlint --edit $1"`